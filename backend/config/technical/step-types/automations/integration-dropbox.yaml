# INTEGRATION_DROPBOX Step Type Definition
stepType: INTEGRATION_DROPBOX
category: AUTOMATION
displayName: "Dropbox"
description: "Upload files, create folders, or find folders in Dropbox"

schema:
  events:
    - name: UPLOAD_FILE
      label: "Upload File"
      description: "Upload a file to a Dropbox folder"
    - name: CREATE_FOLDER
      label: "Create Folder"
      description: "Create a new folder in Dropbox"
    - name: FIND_FOLDER
      label: "Find Folder"
      description: "Search for an existing folder in Dropbox by name"
    - name: UPLOAD_FILE_VIA_PATH
      label: "Upload File via Path"
      description: "Upload a file to a specific Dropbox path"

  fields:
    - name: title
      type: string
      required: true
      description: "Description of the Dropbox action"

    - name: description
      type: string
      required: false
      description: "Additional context (coordinator-only)"

    - name: event
      type: enum
      required: true
      values: [UPLOAD_FILE, CREATE_FOLDER, FIND_FOLDER, UPLOAD_FILE_VIA_PATH]
      description: "Dropbox action to perform"

    - name: connectionId
      type: connectionRef
      required: true
      provider: DROPBOX
      description: "Dropbox OAuth connection to use"

    # Fields for UPLOAD_FILE
    - name: folder
      type: dynamicSelect
      required: false
      source: "dropbox.folders"
      appliesTo: [UPLOAD_FILE]
      description: "Destination folder for the upload"

    - name: file
      type: fileRef
      required: false
      appliesTo: [UPLOAD_FILE, UPLOAD_FILE_VIA_PATH]
      description: "File to upload (supports DDR from prior FILE_REQUEST steps)"

    # Fields for CREATE_FOLDER
    - name: folderName
      type: string
      required: false
      appliesTo: [CREATE_FOLDER]
      description: "Name of the folder to create (supports DDR)"

    - name: parentFolder
      type: dynamicSelect
      required: false
      source: "dropbox.folders"
      appliesTo: [CREATE_FOLDER]
      description: "Parent folder to create the new folder in"

    # Fields for FIND_FOLDER
    - name: searchQuery
      type: string
      required: false
      appliesTo: [FIND_FOLDER]
      description: "Folder name or pattern to search for (supports DDR)"

    # Fields for UPLOAD_FILE_VIA_PATH
    - name: destinationPath
      type: string
      required: false
      appliesTo: [UPLOAD_FILE_VIA_PATH]
      description: "Full Dropbox path for the upload (e.g. /Projects/Client/file.pdf)"

    - name: inputs
      type: inputRef[]
      required: false
      description: "References to data from prior steps"

    - name: visibility.coordinatorOnly
      type: boolean
      required: false
      default: true

completion:
  autoCompletes: true
  noAssignee: true
  coordinatorOnly: true
  description: "Completes when the Dropbox API returns success"

outputs:
  - name: "folderId"
    type: string
    description: "ID of the created or found Dropbox folder"
  - name: "fileUrl"
    type: string
    description: "Shareable URL of the uploaded file"
  - name: "folderPath"
    type: string
    description: "Full path of the created or found folder"

validationRules:
  - rule: "event is not empty"
    message: "A Dropbox event must be selected"
  - rule: "file is set when event is UPLOAD_FILE or UPLOAD_FILE_VIA_PATH"
    message: "A file is required for upload events"
  - rule: "folderName is set when event is CREATE_FOLDER"
    message: "Folder name is required to create a folder"
  - rule: "searchQuery is set when event is FIND_FOLDER"
    message: "Search query is required to find a folder"
  - rule: "destinationPath is set when event is UPLOAD_FILE_VIA_PATH"
    message: "Destination path is required for path-based upload"

aiGuidance:
  whenToUse: |
    Use INTEGRATION_DROPBOX to manage files and folders in Dropbox.
    Examples: archive signed documents, organize client files into folders,
    upload collected files from a flow, find existing project folders.

  whenNotToUse: |
    - Managing files in Google Drive -> use INTEGRATION_GOOGLE_DRIVE
    - Requesting files from assignees -> use FILE_REQUEST step
    - Sending files via email -> use SYSTEM_EMAIL or INTEGRATION_GMAIL

  seQuestions:
    - "What action should be performed in Dropbox (upload, create folder, find folder)?"
    - "Which file from the flow should be uploaded?"
    - "Where in Dropbox should the file or folder go?"
    - "If finding a folder, what name or pattern should we search for?"

  defaults:
    - "UPLOAD_FILE event"
    - "Coordinator-only visibility"

  examples:
    - trigger: "upload to Dropbox"
      mapsTo: INTEGRATION_DROPBOX
    - trigger: "save file to Dropbox"
      mapsTo: INTEGRATION_DROPBOX
    - trigger: "create Dropbox folder"
      mapsTo: INTEGRATION_DROPBOX
    - trigger: "find Dropbox folder"
      mapsTo: INTEGRATION_DROPBOX
    - trigger: "organize in Dropbox"
      mapsTo: INTEGRATION_DROPBOX
